
$(document).ready(function() {
    $(".open-popup").click(function() {
        var p = $(this).attr("href");
        return $(".popup-window").fadeOut(321), $("#popup-wrapper").fadeIn(321), $(p).fadeIn(321), !1
    }), $(".close-popup, #mask").click(function(e) {
        return $(".popup-window, #popup-wrapper").fadeOut(321), !1
    });


    $('.js-form-validate').submit(function(e) {

        $('.error').remove();

        var fio = /^[А-ЯЁ][а-яё]+\s[А-ЯЁ][а-яё]+\s[А-ЯЁ][а-яё]+$/.test($(this).find('input[name=fio]').val());
        // var email = /^([A-Za-z0-9_\.-]+)@([A-Za-z0-9_\.-]+)\.([A-Za-z\.]{2,6})$/.test($(this).find('input[name=email]').val()); // с поддержкой иерархических доменов: user@mail.ru.com
        var email = /^([A-Za-z0-9_\.-]+)@([A-Za-z0-9_-]+)\.([A-Za-z]{2,6})$/.test($(this).find('input[name=email]').val()); // без поддержки иерархических доменов: user@mail.ru
        var password = /^[A-Za-zА-ЯЁа-яё0-9]{6,}$/.test($(this).find('input[name=password]').val());
        var oldPassword = /^[A-Za-zА-ЯЁа-яё0-9]{6,}$/.test($(this).find('input[name=oldpassword]').val());
        var repeatPassword = /^[A-Za-zА-ЯЁа-яё0-9]{6,}$/.test($(this).find('input[name=repeatpassword]').val());

        // Если в форме такого поля нет или оно залочено, пропускаем
        function skipField(form, field) {
            var isField = form.find('input[name=' +field+ ']');
            if (!isField || (isField && isField.parents('.disabled').length > 0)) return true;
            return false;
        }

        if ( skipField($(this),'fio'))
            fio = true;
        if ( skipField($(this),'email') )
            email = true;
        if ( skipField($(this),'password') )
            password = true;
        if ( skipField($(this),'oldpassword') )
            oldPassword = true;
        if ( skipField($(this),'repeatpassword') )
            repeatPassword = true;

        // Позиция сообщения об ошибке - сверху/снизу
        if ($('body').innerHeight() - $(this).offset().top <= 100)
            var error = 'error error_top';
        else
            var error = 'error';

        $(this).find('input[required]').each(function(index, element){
            var name = element.getAttribute('name');

            if (name == 'fio' && !fio)
                $(this).after("<div class='" +error+ "'><i></i><span>ФИО должно состоять из Фамилии, Имени и Отчества</span></div>");
            if (name == 'email' && !email)
                $(this).after("<div class='" +error+ "'><i></i><span>Проверьте правильность e-mail</span></div>");
            if ((name == 'password' && !password) ||
                (name == 'oldpassword' && !oldPassword) ||
                (name == 'repeatpassword' && !repeatPassword) )
                $(this).after("<div class='" +error+ "'><i></i><span>Пароль должен состоять из 6 и более символов</span></div>");
        });

        if ( (password && repeatPassword) && 
             ($(this).find('.error').length == 0) &&
             ($(this).find('input[name=password]').val() !== $(this).find('input[name=repeatpassword]').val()) ) {
            $(this).find('input[name=repeatpassword]').after("<div class='" +error+ "'><i></i><span>Введённые пароли не совпадают!</span></div>");
        }

        if ( $(this).find('.error').length > 0 ) {
            $(this).find('.error:eq(0)').fadeIn(321);
            return false;
        }

        return;
    });

    $('.js-form-validate').on('keypress keyup', function() {
        $('.error').remove();
    });
  })
